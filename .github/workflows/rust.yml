name: Build Greenlight

on: [push, pull_request]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [x86_64-unknown-linux-musl, aarch64-unknown-linux-musl]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        override: true

    - name: Install cross
      run: cargo install cross --git https://github.com/cross-rs/cross

    - name: Build with cross
      uses: actions-rs/cargo@v1
      with:
        command: build
        args: --release --target=${{ matrix.target }}
        use-cross: true

    - name: Upload binary
      uses: actions/upload-artifact@v4
      with:
        name: greenlight-${{ matrix.target }}
        path: target/${{ matrix.target }}/release/greenlight-cli

  test:
    name: Run tests (native)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Run cargo test
      run: cargo test --verbose

  package:
    name: Build RPM (el10 x86_64)
    runs-on: ubuntu-latest
    needs: build
    if: always()
    # run the rpm build inside a CentOS Stream 10 container so rpmbuild and macros match el10
    container:
      image: quay.io/centos/centos:stream10
    steps:
    - uses: actions/checkout@v4

    - name: Download x86_64 binary artifact
      uses: actions/download-artifact@v4
      with:
        name: greenlight-x86_64-unknown-linux-musl
        path: ./artifacts

    - name: Install rpmbuild dependencies
      run: |
        dnf -y update
        dnf -y install rpm-build rpmdevtools redhat-rpm-config make gcc
        dnf clean all

    - name: Prepare rpmbuild tree and copy files
      run: |
        rpmdev-setuptree
        # create a stable buildroot name including commit for uniqueness
        BUILDROOT=$HOME/rpmbuild/BUILDROOT/greenlight-0.1.0-1.x86_64
        mkdir -p "$BUILDROOT/usr/bin"
        cp ./artifacts/greenlight-cli "$BUILDROOT/usr/bin/greenlight"
        install -D -m 0644 packaging/greenlight-required.service "$BUILDROOT/usr/lib/systemd/system/greenlight-required.service"
        install -D -m 0644 packaging/greenlight-wanted.service "$BUILDROOT/usr/lib/systemd/system/greenlight-wanted.service"
        mkdir -p "$BUILDROOT/etc/greenlight"
        install -D -m 0644 packaging/config.toml "$BUILDROOT/etc/greenlight/config.toml"

    - name: Build RPM
      run: |
        RELEASE_TAG="$(date +%Y%m%d%H%M).${GITHUB_SHA::7}"
        rpmbuild -bb packaging/greenlight.spec \
          --define "_topdir $HOME/rpmbuild" \
          --define "binary_path $PWD/artifacts/greenlight-cli" \
          --define "sourcedir $PWD" \
          --define "release_tag ${RELEASE_TAG}"

    - name: Upload RPM artifact
      uses: actions/upload-artifact@v4
      with:
        name: greenlight-rpm-x86_64
        path: /github/home/rpmbuild/RPMS/x86_64/*.rpm

  publish:
    name: Publish Pre-release
    runs-on: ubuntu-latest
    needs: package
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Download RPM artifact
      uses: actions/download-artifact@v4
      with:
        name: greenlight-rpm-x86_64
        path: ./dist

    - name: Create Pre-release
      uses: softprops/action-gh-release@v2
      with:
        prerelease: true
        tag_name: "build-${{ github.sha }}"
        name: "Greenlight Pre-release (${{ github.sha }})"
        body: |
          Automated build from main.
        files: ./dist/*.rpm
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
